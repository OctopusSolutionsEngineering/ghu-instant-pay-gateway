name: Build and Push Docker Image - SLSA

on:
  #push:
  #  paths:
  #    - "API/**"
  #  branches:
  #    - main
  schedule:
    - cron: "12 13-22 * * 1-5"
  workflow_dispatch: {}

env:
  OCTOPUS_URL: https://demo.octopus.app
  OCTOPUS_SERVICE_ACCOUNT: 4d50c8ac-1515-4351-96a7-4a82d55d55ff
  OCTOPUS_SPACE: "Deep Ellum Tech"
  OCTOPUS_PROJECT: "Instant Pay Gateway"
  DOCKER_HUB_REPOSITORY: octopussolutionsengineering/ghu-instant-pay-gateway
  SBOM_PACKAGE: ghu-instant-pay-gateway.sbom

jobs:
  configure:
    runs-on: ubuntu-latest
    name: Configure Workflow
    outputs:
      version: ${{ steps.version-generator.outputs.version }}
    steps:
      - name: Set version number
        id: version-generator
        run: echo "version=$(date +'%y.%m.%d%H%M%S')" >> $GITHUB_OUTPUT

  scan:
    runs-on: ubuntu-latest
    name: Scan Code
    permissions:
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner on repo
        uses: aquasecurity/trivy-action@0.32.0
        with:
          scan-type: "fs"
          ignore-unfixed: true
          exit-code: "1"
          format: "sarif"
          output: "trivy-results.sarif"
          severity: "MEDIUM,HIGH,CRITICAL"

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: "trivy-results.sarif"

  create-gh-release:
    name: Create GitHub Release
    needs: [configure, scan]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
    steps:
      - name: Checkout code to build website
        uses: actions/checkout@v1

      - name: Create Release for GitHub
        id: create_release
        uses: ncipollo/release-action@v1
        if: github.ref == 'refs/heads/main'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # This token is provided by Actions, you do not need to create your own token
        with:
          tag: "${{ needs.configure.outputs.version }}"
          name: Release ${{ needs.configure.outputs.version }}
          body: |
            Automatic Release creation by GitHub Action
            Commit Message: ${{ github.event.head_commit.message }}
          draft: false

  build:
    name: Build and Scan Images
    needs: [configure, scan, create-gh-release]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    outputs:
      app_hash: ${{ steps.push-docker-images.outputs.DEMO_APP_DOCKER_SHA }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Login to Octopus Deploy
        uses: OctopusDeploy/login@v1
        with:
          server: ${{ env.OCTOPUS_URL }}
          service_account_id: ${{ env.OCTOPUS_SERVICE_ACCOUNT }}

      - name: Login to Docker Hub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build API container
        id: build_container
        working-directory: ./API/
        run: |
          docker build -f "Dockerfile" \
            --tag $DOCKER_HUB_REPOSITORY:${{ needs.configure.outputs.version }} .

      - name: Run Trivy vulnerability scanner on docker container
        uses: aquasecurity/trivy-action@0.32.0
        with:
          image-ref: ${{ env.DOCKER_HUB_REPOSITORY }}:${{ needs.configure.outputs.version }}
          format: "table"
          exit-code: "0"
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "HIGH,CRITICAL"

      - name: Push Docker images
        id: push-docker-images
        working-directory: ./API
        run: |
          docker push $DOCKER_HUB_REPOSITORY:${{ needs.configure.outputs.version }}

          dockerSha=$(docker manifest inspect $DOCKER_HUB_REPOSITORY:${{ needs.configure.outputs.version }} -v | jq -r '.Descriptor.digest')
          echo "Docker sha is $dockerSha"            
          echo "DEMO_APP_DOCKER_SHA=$dockerSha" >> $GITHUB_OUTPUT

      - uses: OctopusDeploy/push-build-information-action@v3
        name: Push build information ğŸ™
        with:
          version: ${{ needs.configure.outputs.version }}
          packages: |
            ${{ env.DOCKER_HUB_REPOSITORY }}

  sbom:
    name: Generate and Publish SBOM
    outputs:
      sbom_hash: ${{ steps.determine_sbom_hash.outputs.SBOM_HASH }}
    needs: [configure, scan, create-gh-release]
    runs-on: ubuntu-latest
    permissions:
      # Add any additional permissions your job requires here
      id-token: write # This is required to obtain the OIDC Token for Octopus Deploy
    steps:
      - name: Checkout the code for SBOM
        uses: actions/checkout@v1
        with:
          fetch-depth: "0"

      - name: Run Trivy in GitHub SBOM mode and submit results to Dependency Graph
        uses: aquasecurity/trivy-action@0.32.0
        with:
          scan-type: "fs"
          format: "github"
          output: "dependency-results.sbom.json"
          scan-ref: "."
          github-pat: ${{ secrets.GITHUB_TOKEN }}

      - name: Package SBOM
        id: "sbom_package"
        uses: OctopusDeploy/create-zip-package-action@v3
        with:
          package_id: "${{ env.SBOM_PACKAGE }}"
          version: "${{ needs.configure.outputs.version }}"
          base_path: "./"
          files: "dependency-results.sbom.json"
          output_folder: packaged

      - name: Create the Subject Checksum file for Attestation Build Provenance
        id: determine_sbom_hash
        shell: pwsh
        run: |
          $packageHash = Get-FileHash -path "packaged/${{ env.SBOM_PACKAGE }}.${{ needs.configure.outputs.version }}.zip" -Algorithm SHA256
          $hashToSave = $packageHash.Hash 
          Write-Host "The SBOM package hash is $hashToSave"

          "SBOM_HASH=$hashToSave" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Login to Octopus Deploy ğŸ™
        uses: OctopusDeploy/login@v1
        with:
          server: ${{ env.OCTOPUS_URL }}
          service_account_id: ${{ env.OCTOPUS_SERVICE_ACCOUNT }}

      - name: Push build information to Octopus ğŸ™
        uses: OctopusDeploy/push-build-information-action@v3
        with:
          packages: |
            ${{ env.SBOM_PACKAGE }}
          version: "${{ needs.configure.outputs.version }}"

      - name: Push packages to Octopus ğŸ™
        uses: OctopusDeploy/push-package-action@v3
        with:
          packages: |
            packaged/${{ env.SBOM_PACKAGE }}.${{ needs.configure.outputs.version }}.zip

  create_attestations:
    name: Create Attestations
    needs: [configure, scan, create-gh-release, build, sbom]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      attestations: write # Required to publish attestations
    steps:
      - name: Create the subject checksum file for provenance
        shell: pwsh
        run: |
          $cleanedSbomSha = $("${{ needs.sbom.outputs.sbom_hash }}" -replace "sha256:", "").Trim()
          $cleanedImageSha = $("${{ needs.build.outputs.app_hash }}" -replace "sha256:", "").Trim()

          $imageSubject = "${{ env.DOCKER_HUB_REPOSITORY }}:${{ needs.configure.outputs.version }}".Trim()
          $sbomSubject = "${{ env.SBOM_PACKAGE }}.${{ needs.configure.outputs.version }}.zip".Trim()

          Write-Host "The API information is $cleanedImageSha  $imageSubject"
          Write-Host "The SBOM information is $cleanedSbomSha  $sbomSubject"

          $subjectText = @"
          $cleanedImageSha  $imageSubject
          $cleanedSbomSha  $sbomSubject
          "@

          Write-Host "Creating the checksums file"
          New-Item -Path . -Name "subject.checksums.txt" -ItemType "File" -Value $subjectText
      - name: Generate attestation from provenance
        uses: actions/attest-build-provenance@v2
        id: websiteattest
        with:
          subject-checksums: subject.checksums.txt

  create_release:
    needs: [configure, create_attestations]
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    name: "ğŸ™ Create release ${{ needs.configure.outputs.version }}"
    outputs:
      release_number: ${{ needs.configure.outputs.version }}
    permissions:
      id-token: write

    steps:
      - name: ğŸ™ Login to Octopus Deploy
        uses: OctopusDeploy/login@v1
        with:
          server: ${{ env.OCTOPUS_URL }}
          service_account_id: ${{ env.OCTOPUS_SERVICE_ACCOUNT }}
      - name: Create a release in Octopus Deploy ğŸ™
        uses: OctopusDeploy/create-release-action@v4
        with:
          project: ${{ env.OCTOPUS_PROJECT }}
          release_number: ${{ needs.configure.outputs.version }}

  deploy-to-development-alpha:
    needs: [create_release]
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    name: "ğŸ™ Deploy release ${{ needs.create_release.outputs.release_number }} to Development - Alpha regions"
    outputs:
      server_tasks: ${{ steps.deploy-release-to-alpha.outputs.server_tasks }}
    permissions:
      id-token: write

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - name: ğŸ™ Login to Octopus Deploy
        uses: OctopusDeploy/login@v1
        with:
          server: ${{ env.OCTOPUS_URL }}
          service_account_id: ${{ env.OCTOPUS_SERVICE_ACCOUNT }}
      - uses: OctopusDeploy/deploy-release-tenanted-action@v3
        id: "deploy-release-to-alpha"
        name: "ğŸ™ Deploy release ${{ needs.create_release.outputs.release_number }} to  Development - Alpha regions"
        with:
          project: ${{ env.OCTOPUS_PROJECT }}
          release_number: ${{ needs.create_release.outputs.release_number }}
          environment: "Development"
          tenant_tags: "Release Ring/Alpha"
      - id: "print-tasks"
        run: echo "${{ steps.deploy-release-to-alpha.outputs.server_tasks }}"

  wait-for-development-alpha:
    needs: [ create_release, deploy-to-development-alpha ]
    runs-on: ubuntu-latest
    name: "ğŸ™ Wait for deployment of ${{ needs.create_release.outputs.release_number }} to  Development - Alpha regions to complete"
    strategy:
      matrix:
        value: ${{ fromJson(needs.deploy-to-development-alpha.outputs.server_tasks) }}
    permissions:
      id-token: write
  
    steps:
      - name: ğŸ™ Login to Octopus Deploy
        uses: OctopusDeploy/login@v1
        with:
          server: ${{ env.OCTOPUS_URL }}
          service_account_id: ${{ env.OCTOPUS_SERVICE_ACCOUNT }}
      - uses: OctopusDeploy/await-task-action@v3
        id: "wait-for-deploy-alpha"
        name: "ğŸ™ Wait for deployment of ${{ needs.create_release.outputs.release_number }} to ${{ matrix.value.tenantName }} to complete"
        with:
          server_task_id: ${{ matrix.value.serverTaskId }}

### TEST ###
  deploy-to-test-alpha:
    needs: [ create_release, wait-for-development-alpha ]
    runs-on: ubuntu-latest
    name: "ğŸ™ Deploy release ${{ needs.create_release.outputs.release_number }} to Test - Alpha regions"
    outputs:
      server_tasks: ${{ steps.deploy-release-to-alpha.outputs.server_tasks }}
    permissions:
      id-token: write

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - name: ğŸ™ Login to Octopus Deploy
        uses: OctopusDeploy/login@v1
        with:
          server: ${{ env.OCTOPUS_URL }}
          service_account_id: ${{ env.OCTOPUS_SERVICE_ACCOUNT }}
      - uses: OctopusDeploy/deploy-release-tenanted-action@v3
        id: "deploy-release-to-alpha"
        name: "ğŸ™ Deploy release ${{ needs.create_release.outputs.release_number }} to  Test - Alpha regions"
        with:
          project: ${{ env.OCTOPUS_PROJECT }}
          release_number: ${{ needs.create_release.outputs.release_number }}
          environment: "Test"
          tenant_tags: "Release Ring/Alpha"
      - id: "print-tasks"
        run: echo "${{ steps.deploy-release-to-alpha.outputs.server_tasks }}"

  wait-for-test-alpha:
    needs: [ create_release, deploy-to-test-alpha ]
    runs-on: ubuntu-latest
    name: "ğŸ™ Wait for deployment of ${{ needs.create_release.outputs.release_number }} to  Test - Alpha regions to complete"
    strategy:
      matrix:
        value: ${{ fromJson(needs.deploy-to-test-alpha.outputs.server_tasks) }}
    permissions:
      id-token: write
  
    steps:
      - name: ğŸ™ Login to Octopus Deploy
        uses: OctopusDeploy/login@v1
        with:
          server: ${{ env.OCTOPUS_URL }}
          service_account_id: ${{ env.OCTOPUS_SERVICE_ACCOUNT }}
      - uses: OctopusDeploy/await-task-action@v3
        id: "wait-for-deploy-alpha"
        name: "ğŸ™ Wait for deployment of ${{ needs.create_release.outputs.release_number }} to ${{ matrix.value.tenantName }} to complete"
        with:
          server_task_id: ${{ matrix.value.serverTaskId }}

### PRODUCTION ###
  deploy-to-production-alpha:
    needs: [ create_release, wait-for-test-alpha ]
    runs-on: ubuntu-latest
    name: "ğŸ™ Deploy release ${{ needs.create_release.outputs.release_number }} to Production - Alpha regions"
    outputs:
      server_tasks: ${{ steps.deploy-release-to-alpha.outputs.server_tasks }}
    permissions:
      id-token: write

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - name: ğŸ™ Login to Octopus Deploy
        uses: OctopusDeploy/login@v1
        with:
          server: ${{ env.OCTOPUS_URL }}
          service_account_id: ${{ env.OCTOPUS_SERVICE_ACCOUNT }}
      - uses: OctopusDeploy/deploy-release-tenanted-action@v3
        id: "deploy-release-to-alpha"
        name: "ğŸ™ Deploy release ${{ needs.create_release.outputs.release_number }} to  Production - Alpha regions"
        with:
          project: ${{ env.OCTOPUS_PROJECT }}
          release_number: ${{ needs.create_release.outputs.release_number }}
          environment: "Production"
          tenant_tags: "Release Ring/Alpha"

  wait-for-production-alpha:
    needs: [ create_release, deploy-to-production-alpha ]
    runs-on: ubuntu-latest
    name: "ğŸ™ Wait for deployment of ${{ needs.create_release.outputs.release_number }} to  Production - Alpha regions to complete"
    strategy:
      matrix:
        value: ${{ fromJson(needs.deploy-to-production-alpha.outputs.server_tasks) }}
    permissions:
      id-token: write
  
    steps:
      - name: ğŸ™ Login to Octopus Deploy
        uses: OctopusDeploy/login@v1
        with:
          server: ${{ env.OCTOPUS_URL }}
          service_account_id: ${{ env.OCTOPUS_SERVICE_ACCOUNT }}
      - uses: OctopusDeploy/await-task-action@v3
        id: "wait-for-deploy-alpha"
        name: "ğŸ™ Wait for deployment of ${{ needs.create_release.outputs.release_number }} to ${{ matrix.value.tenantName }} to complete"
        with:
          server_task_id: ${{ matrix.value.serverTaskId }}

  approve-production-alpha-deployment:
    name: âœ… Approve Alpha deployment
    needs: [create_release, wait-for-production-alpha]
    runs-on: ubuntu-latest
    environment: 'alpha'
      
    steps:
      - name: Gather Alpha approval
        run: echo "âœ… Approval gathered"

  deploy-to-production-beta:
    # The type of runner that the job will run on
    needs: [create_release, approve-production-alpha-deployment]
    runs-on: ubuntu-latest
    name: "ğŸ™ Deploy release ${{ needs.create_release.outputs.release_number }} to Production - Beta regions"
    outputs:
      server_tasks: ${{ steps.deploy-release-to-beta.outputs.server_tasks }}
    permissions:
      id-token: write

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - name: ğŸ™ Login to Octopus Deploy
        uses: OctopusDeploy/login@v1
        with:
          server: ${{ env.OCTOPUS_URL }}
          service_account_id: ${{ env.OCTOPUS_SERVICE_ACCOUNT }}
      - uses: OctopusDeploy/deploy-release-tenanted-action@v3
        id: "deploy-release-to-beta"
        name: "ğŸ™ Deploy release ${{ needs.create_release.outputs.release_number }} to Production - Beta regions"
        with:
          project: ${{ env.OCTOPUS_PROJECT }}
          release_number: ${{ needs.create_release.outputs.release_number }}
          environment: "Production"
          tenant_tags: "Release Ring/Beta"
      - id: "print-tasks"
        run: echo "${{ steps.deploy-release-to-beta.outputs.server_tasks }}"

  wait-for-production-beta:
    needs: [ create_release, deploy-to-production-beta ]
    runs-on: ubuntu-latest
    name: "ğŸ™ Wait for deployment of ${{ needs.create_release.outputs.release_number }} to Production - Beta regions to complete"
    strategy:
      matrix:
        value: ${{ fromJson(needs.deploy-to-production-beta.outputs.server_tasks) }}
    permissions:
      id-token: write
  
    steps:
      - name: ğŸ™ Login to Octopus Deploy
        uses: OctopusDeploy/login@v1
        with:
          server: ${{ env.OCTOPUS_URL }}
          service_account_id: ${{ env.OCTOPUS_SERVICE_ACCOUNT }}
      - uses: OctopusDeploy/await-task-action@v3
        id: "wait-for-deploy-beta"
        name: "ğŸ™ Wait for deployment of ${{ needs.create_release.outputs.release_number }} to ${{ matrix.value.tenantName }} to complete"
        with:
          server_task_id: ${{ matrix.value.serverTaskId }}

  approve-production-beta-deployment:
    name: âœ… Approve Beta deployment
    needs: [ create_release, wait-for-production-beta]
    runs-on: ubuntu-latest
    environment: 'beta'
      
    steps:
      - name: Gather Beta approval
        run: echo "âœ… Approval gathered"

  deploy-to-production-stable:
    needs: [ create_release, approve-production-beta-deployment]
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    name: "ğŸ™ Deploy release ${{ needs.create_release.outputs.release_number }} to Production - Stable regions"
    outputs:
      server_tasks: ${{ steps.deploy-release-to-stable.outputs.server_tasks }}
    permissions:
      id-token: write

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - name: ğŸ™ Login to Octopus Deploy
        uses: OctopusDeploy/login@v1
        with:
          server: ${{ env.OCTOPUS_URL }}
          service_account_id: ${{ env.OCTOPUS_SERVICE_ACCOUNT }}
      - uses: OctopusDeploy/deploy-release-tenanted-action@v3
        id: "deploy-release-to-stable"
        name: "ğŸ™ Deploy release ${{ needs.create_release.outputs.release_number }} to Production - Stable regions"
        with:
          project: ${{ env.OCTOPUS_PROJECT }}
          release_number: ${{ needs.create_release.outputs.release_number }}
          environment: "Production"
          tenant_tags: "Release Ring/Stable"
      - id: "print-tasks"
        run: echo "${{ steps.deploy-release-to-stable.outputs.server_tasks }}"

  wait-for-stable:
    needs: [ create_release, deploy-to-production-stable ]
    runs-on: ubuntu-latest
    name: "ğŸ™ Wait for deployment of ${{ needs.create_release.outputs.release_number }} to Production - Stable regions to complete"
    strategy:
      matrix:
        value: ${{ fromJson(needs.deploy-to-production-stable.outputs.server_tasks) }}
    permissions:
      id-token: write
  
    steps:
      - name: ğŸ™ Login to Octopus Deploy
        uses: OctopusDeploy/login@v1
        with:
          server: ${{ env.OCTOPUS_URL }}
          service_account_id: ${{ env.OCTOPUS_SERVICE_ACCOUNT }}
      - uses: OctopusDeploy/await-task-action@v3
        id: "wait-for-deploy-stable"
        name: "ğŸ™ Wait for deployment of ${{ needs.create_release.outputs.release_number }} to ${{ matrix.value.tenantName }} to complete"
        with:
          server_task_id: ${{ matrix.value.serverTaskId }}
